apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: lxd-initializer
  namespace: capmaas-system
  labels:
    app: lxd-initializer
    cluster.x-k8s.io/provider: infrastructure-maas
spec:
  selector:
    matchLabels:
      app: lxd-initializer
  template:
    metadata:
      labels:
        app: lxd-initializer
    spec:
      serviceAccountName: lxd-initializer
      hostNetwork: true
      hostPID: true
      containers:
      - name: lxd-initializer
        image: us-east1-docker.pkg.dev/spectro-images/dev/cluster-api/capmaas-lxd-initializer:v0.0.1
        imagePullPolicy: Always
        securityContext:
          privileged: true
        volumeMounts:
        - name: var-lib-lxd
          mountPath: /var/lib/lxd
        - name: var-snap-lxd
          mountPath: /var/snap/lxd
        - name: run
          mountPath: /run
        - name: tmp
          mountPath: /tmp
        command:
        - /lxd-initializer
        args:
        - --action=daemon
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: NODE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: STORAGE_BACKEND
          value: "zfs"
        - name: NETWORK_BRIDGE
          value: "br0"
        - name: SKIP_NETWORK_UPDATE
          value: "true"
        - name: ZONE
          value: "default"
        - name: RESOURCE_POOL
          value: "" # Auto-detect resource pool
      volumes:
      - name: var-lib-lxd
        hostPath:
          path: /var/lib/lxd
      - name: var-snap-lxd
        hostPath:
          path: /var/snap/lxd
      - name: run
        hostPath:
          path: /run
      - name: tmp
        hostPath:
          path: /tmp 